{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Breeze — Новости{% endblock %}

{% block content %}
    <main class="content">
        <section class="section container">
            <header class="section__header header-center">
                <h1 class="section__title h2">Новости</h1>
                {% if user.is_authenticated and user.is_superuser or user.is_authenticated and user.profile.role == 'manager' %}
                    <a href="{% url 'shop:news_create' %}" class="catalog__button button button-add">Добавить новость</a>
                {% endif %}
            </header>
            <div class="section__body">
                <div class="all-news">
                    <!-- Форма фильтров: метод GET -->
                    <form method="get" action="{% url 'shop:news_list' %}" class="all-news__selection">
                    <div class="all-news__selection-inputs">
                        <label for="search" class="visually-hidden">Поиск</label>
                        <input
                        type="text"
                        name="q"
                        id="search"
                        class="all-news__input input"
                        placeholder="Поиск"
                        value="{{ q|default:'' }}"
                        >

                        <label for="order" class="visually-hidden">Сортировка</label>
                        <select id="order" name="order" class="all-news__select select">
                            <option value="newest" {% if order == 'newest' %}selected{% endif %}>Сначала новые</option>
                            <option value="oldest" {% if order == 'oldest' %}selected{% endif %}>Сначала старые</option>
                        </select>
                    </div>

                    <button class="all-news__button button" type="submit">Применить</button>
                    </form>
                    <div class="all-news__main">
                        <ul class="news__list">
                            {% for n in news_list %}
                                    <li class="news__item">
                                            <article class="news-card">
                                                <div class="news-card__image-wrapper">
                                                    {% if n.image %}
                                                        <img src="{{ n.image.url }}" alt="{{ n.title }}" class="news-card__image" width="500" height="400" loading="lazy">
                                                    {% else %}
                                                        <img src="{% static 'images/image.png' %}" alt="{{ n.title }}" class="news-card__image">
                                                    {% endif %}
                                                </div>
                                                <div class="news-card__body">
                                                    <h3 class="news-card__title">{{ n.title }}</h3>
                                                    <div class="news-card__date"><time datetime="{{ n.published_at }}">{{ n.published_at }}</time></div>
                                                    <div class="news-card__description">{{ n.content|truncatechars:150 }}</div>
                                                    <a href="{% url 'shop:news_detail' n.pk %}" class="news-card__link">Читать далее</a>
                                                    {% if user.is_authenticated and user.is_superuser or user.is_authenticated and user.profile.role == 'manager' %}
                                                        <div class="news-card__admin">
                                                            <a href="{% url 'shop:news_edit' n.pk %}" class="button button-white">Редактировать</a>
                                                            <form action="{% url 'shop:news_delete' n.pk %}" method="post" style="display:inline">
                                                            {% csrf_token %}
                                                            <button class="button button-delete">Удалить</button>
                                                            </form>
                                                        </div>
                                                    {% endif %}
                                                </div>   
                                            </article>
                                    </li>
                                 {% empty %}
                                    <li>Новостей пока нет.</li>
                                {% endfor %}

                        </ul>
                    </div>
                    {% if page_obj.has_other_pages %}
                        <nav class="all-news__pagination" aria-label="Пагинация новостей">

                                <div class="pagination__button-arrow">
                                    {% if page_obj.has_previous %}
                                        <div class="pagination__button-item">
                                            <a class="button" href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.previous_page_number }}">←</a>
                                        </div>
                                    {% else %}
                                        <div class="pagination__button-item"><span class="button disabled">←</span></div>
                                    {% endif %}
                                </div>
                                <div class="pagination">
                                    {# Показываем небольшой диапазон страниц вокруг текущей #}
                                    {% for num in page_obj.paginator.page_range %}
                                        {% if num >= page_obj.number|add:'-3' and num <= page_obj.number|add:'3' %}
                                            <ul class="pagination__list">
                                                {% if num == page_obj.number %}
                                                    <li class="pagination__item"><span class="pagination__button is-current"></span></li>
                                                {% else %}
                                                    <li class="pagination__item"><a class="pagination__button" href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ num }}"></a></li>
                                                {% endif %}
                                            </ul>    
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="pagination_button-arrow">
                                    {% if page_obj.has_next %}  
                                        <div class="pagination__button-item">
                                            <a class="button" href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.next_page_number }}">→</a>
                                        </div>
                                    {% else %}
                                        <div class="pagination__button-item"><span class="button disabled">→</span></div>
                                    {% endif %}
                                </div>

                        </nav>
                    {% endif %}
                </div>
            </div>
        </section>
    </main>
{% endblock %}