{% extends 'shop/base.html' %}
{% load static %}


{% block title %}Breeze — Корзина{% endblock %}

{% block content %}
    <main class="content">
        <section class="section container section-blue">
            <header class="section__header header-center">
                <h1 class="section__title h2">Корзина</h1>
            </header>
            <div class="section__body">
                <div class="cart">
                    {% if items %}
                        <ul class="cart-cards_list">
                             {% for it in items %}
                                <li class="cart-cards_item">
                                    <div class="cart-card">
                                        <div class="cart-card__image-wrapper">
                                            <img src="{{ it.image }}" alt="{{ it.title }}" class="cart-card__image" width="250" height="250" loading="lazy">
                                        </div>
                                        <div class="cart-card__info">
                                            <div class="cart-card__info-left">
                                                <h3 class="cart-card__title">{{ it.title }}</h3>
                                                 {% comment %} если есть категория в product: {% if it.product.category %} {% endif %} {% endcomment %}
                                                <p class="categorie">
                                                    {% if it.product and it.product.category %}{{ it.product.category }}{% endif %}
                                                </p>
                                                <form action="{% url 'shop:remove_from_cart' it.product_id %}" method="post" style="display:inline">
                                                    {% csrf_token %}
                                                    <button class="cart-card__button button button-delete" type="submit">Удалить</button>
                                                </form>
                                            </div>
                                            <ul class="cart-card__info-list">
                                                <li class="cart-card__info-item">
                                                    <label class="cart-card__price">Цена, ₽</label>
                                                    <p class="cart-card__price">{{ it.price }}</p>
                                                </li>
                                                <li class="cart-card__info-item">
                                                     <form action="{% url 'shop:update_cart' %}" method="post" class="cart-card__info-qty">
                                                        {% csrf_token %}
                                                        <label class="cart-card__qty">Количество, шт</label>
                                                        <input type="hidden" name="product_id" value="{{ it.product_id }}">
                                                        <input 
                                                            name="qty"
                                                            type="number"
                                                            min="1"
                                                            value="{{ it.qty }}"
                                                            class="cart-card__count-input input"
                                                        >
                                                        <button class="button button-blue" type="submit">Обновить</button>
                                                    </form>
                                                </li>
                                                <li class="cart-card__info-item">
                                                    <label class="cart-card__info-amount">Стоимость, ₽</label>
                                                    <p class="cart-card__amount">{{ it.line_total }}</p>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                        <div class="cart__summary">
                            Подытог: <span id="subtotal">{{ total }}</span> ₽
                        </div>   
                    {% else %}
                        <p>Корзина пуста.</p>
                        <p>Чтобы добавить товары, перейдите в <a href="{% url 'shop:catalog' %}">каталог</a>.</p>
                    {% endif %}                
                </div>
            </div>
        </section>
        
        <section class="section container">
            <header class="section__header header">
                <h2 class="section__title h3">Детали доставки</h1>
            </header>
            <div class="section__body">
                <div class="delivery">
                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'shop:order_create' %}">
                            {% csrf_token %}
                            <div class="delivery__list">
                                <label><input type="radio" name="delivery" value="pickup" checked> Самовывоз: Москва, ул. Ленина, д.1</label>
                                <label><input type="radio" name="delivery" value="mail"> Почта: 300 ₽</label>
                                <label><input type="radio" name="delivery" value="courier"> Курьер: 500 ₽</label>

                                <label for="address" class="visually-hidden">Адрес</label>
                                <input id="address" name="address" type="text" class="delivery__info-input input" placeholder="Адрес для доставки">
                            </div>

                            <div class="cart__summary">Итого: <strong id="grand-total">{{ total }}</strong> ₽</div>

                            <div class="delivery__button-order">
                                <button class="cart-card__button button button-order" type="submit">Оформить заказ</button>
                            </div>
                        </form>
                    {% else %}
                        <p>Корзина пуста. <a href="{% url 'shop:catalog' %}">Перейти в каталог</a></p>
                    {% endif %}
                </div>
            </div>
        </section>

        {% if created %}
            <dialog id="order-modal" class="modal" aria-hidden="true" role="dialog" style="display:none;">
                <div class="modal__backdrop"></div>
                <div class="modal__dialog" role="document" aria-labelledby="order-modal-title">
                    <h2 id="order-modal-title">Заказ оформлен</h2>
                    <p>Ваш заказ успешно оформлен, вы можете проверить его статус на странице "Мои заказы"</p>
                    <button id="order-modal-ok" class="button">ОК</button>
                </div>
            </dialog>
        {% endif %}
    </main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const deliveryPrices = { pickup: 0, mail: 300, courier: 500 };
  const subtotalEl = document.getElementById('subtotal');
  const grandTotalEl = document.getElementById('grand-total');

  function parseNumber(s){ return Number(String(s).replace(',', '.')) || 0; }

  function updateGrandTotal() {
    const subtotal = parseNumber(subtotalEl.textContent);
    const chosen = document.querySelector('input[name="delivery"]:checked');
    const delCost = chosen ? (deliveryPrices[chosen.value] || 0) : 0;
    grandTotalEl.textContent = (subtotal + delCost).toFixed(2);
  }

  // меняем итог при смене доставки
  document.querySelectorAll('input[name="delivery"]').forEach(r => {
    r.addEventListener('change', updateGrandTotal);
  });

  // обновляем строки (если пользователь меняет qty локально) — НЕ синхронизировано с сервером здесь,
  // если хочешь, можно отправлять update_cart на каждое изменение. Пока только обновление UI.
  document.querySelectorAll('.cart-card__count-input').forEach(input => {
    input.addEventListener('change', function () {
      const pid = this.dataset.productId;
      const qty = Number(this.value) || 1;
      const lineEl = document.getElementById('line-' + pid);
      const price = parseNumber(lineEl.textContent) / (qty || 1); // old hack — лучше перезапросить
      // безопаснее: пересчитать, получив цену из DOM:
      const priceEl = this.closest('.cart-card__info').querySelector('.cart-card__price');
      const priceVal = parseNumber(priceEl.textContent);
      lineEl.textContent = (priceVal * qty).toFixed(2);

      // пересчёт подытога
      let newSubtotal = 0;
      document.querySelectorAll('.cart-card__amount').forEach(el => {
        newSubtotal += parseNumber(el.textContent);
      });
      subtotalEl.textContent = newSubtotal.toFixed(2);
      updateGrandTotal();
    });
  });

  // initial update
  updateGrandTotal();
});
</script>
{% endblock %}