{% extends 'shop/base.html' %}
{% load static %}


{% block title %}Breeze — Корзина{% endblock %}

{% block content %}
    <main class="content">
        <section class="section container section-blue">
            <header class="section__header header-center">
                <h1 class="section__title h2">Корзина</h1>
            </header>
            <div class="section__body">
                <div class="cart">
                    {% if items %}
                        <ul class="cart-cards_list">
                             {% for it in items %}
                                <li class="cart-cards_item">
                                    <div class="cart-card">
                                        <div class="cart-card__image-wrapper">
                                            <img src="{{ it.image }}" alt="{{ it.title }}" class="cart-card__image" width="250" height="250" loading="lazy">
                                        </div>
                                        <div class="cart-card__info">
                                            <div class="cart-card__info-left">
                                                <h3 class="cart-card__title">{{ it.title }}</h3>
                                                 {% comment %} если есть категория в product: {% if it.product.category %} {% endif %} {% endcomment %}
                                                <p class="categorie">
                                                    {% if it.product and it.product.category %}{{ it.product.category }}{% endif %}
                                                </p>
                                                <form action="{% url 'shop:remove_from_cart' it.product_id %}" method="post" style="display:inline">
                                                    {% csrf_token %}
                                                    <button class="cart-card__button button button-delete" type="submit">Удалить</button>
                                                </form>
                                            </div>
                                            <ul class="cart-card__info-list">
                                                <li class="cart-card__info-item">
                                                    <label class="cart-card__price">Цена, ₽</label>
                                                    <p class="cart-card__price">{{ it.price }}</p>
                                                </li>
                                                <li class="cart-card__info-item">
                                                     <form action="{% url 'shop:update_cart' %}" method="post" class="cart-card__info-qty">
                                                        {% csrf_token %}
                                                        <label class="cart-card__qty">Количество, шт</label>
                                                        <input type="hidden" name="product_id" value="{{ it.product_id }}">
                                                        <input 
                                                            name="qty"
                                                            type="number"
                                                            min="1"
                                                            value="{{ it.qty }}"
                                                            class="cart-card__count-input input"
                                                        >
                                                        <button class="button button-blue" type="submit">Обновить</button>
                                                    </form>
                                                </li>
                                                <li class="cart-card__info-item">
                                                    <label class="cart-card__info-amount">Стоимость, ₽</label>
                                                    <p class="cart-card__amount">{{ it.line_total }}</p>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                        <div class="cart__summary">
                            <span>Итого:</span>
                            <p>  {{ total }}, ₽</p>
                        </div>   
                    {% else %}
                        <p>Корзина пуста.</p>
                        <p>Чтобы добавить товары, перейдите в <a href="{% url 'shop:catalog' %}">каталог</a>.</p>
                    {% endif %}                
                </div>
            </div>
        </section>
        
        <section class="section container">
            <header class="section__header header">
                <h2 class="section__title h3">Детали доставки</h1>
            </header>
            <div class="section__body">
                <div class="delivery">
                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'shop:order_create' %}">
                            {% csrf_token %}
                            <div class="delivery__list">
                                <label><input type="radio" name="delivery" value="courier"> Курьер (500₽)</label>
                                <label><input type="radio" name="delivery" value="mail"> Почта (300₽)</label>
                                <label><input type="radio" name="delivery" value="pickup" checked> Самовывоз (0₽)</label>
                            </div>

                            <label for="address" class="visually-hidden">Адрес</label>
                            <textarea name="address" id="address" class="input" placeholder="Введите адрес (если нужно)"></textarea>

                            <label for="payment_method" class="visually-hidden">Оплата</label>
                            <select name="payment_method" id="payment_method" class="select">
                                <option value="card">Карта</option>
                                <option value="cash">Наличные</option>
                            </select>

                            <div class="cart__summary">
                                <span>Итого:</span>
                                <p id="order-total">{{ total }} ₽</p> <!-- total вычисляется на сервере при рендере -->
                            </div>

                            <button type="submit" class="button button-order">Оформить заказ</button>
                        </form>
                    {% else %}
                        <p>Корзина пуста. <a href="{% url 'shop:catalog' %}">Перейти в каталог</a></p>
                    {% endif %}
                </div>
            </div>
        </section>

        {% if created %}
            <dialog id="order-modal" class="modal" aria-hidden="true" role="dialog" style="display:none;">
                <div class="modal__backdrop"></div>
                <div class="modal__dialog" role="document" aria-labelledby="order-modal-title">
                    <h2 id="order-modal-title">Заказ оформлен</h2>
                    <p>Ваш заказ успешно оформлен, вы можете проверить его статус на странице "Мои заказы"</p>
                    <button id="order-modal-ok" class="button">ОК</button>
                </div>
            </dialog>
        {% endif %}
    </main>
{% endblock %}